<!DOCTYPE html>
<html>
<head>
    <title>Hough Transform for Lines using OpenCV.js</title>
    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</head>
<body>
    <input type="file" onchange="onFileSelected(event)">
    <br><br>
    <canvas id="canvasInput"></canvas>
    <canvas id="canvasOutput"></canvas>
    
    <script type="text/javascript">
        // Load OpenCV.js
        function onOpenCvReady() {
            document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
        }

        // Function to perform Hough Transform for lines
        function performHoughTransform(src) {
            // Convert image to grayscale
            let src_gray = new cv.Mat();
            cv.cvtColor(src, src_gray, cv.COLOR_RGBA2GRAY);

            // Apply Canny edge detection
            let edges = new cv.Mat();
            cv.Canny(src_gray, edges, 50, 200, 3, false);

            // Apply Standard Hough Line Transform
            let lines = new cv.Mat();
            cv.HoughLines(edges, lines, 1, Math.PI/180, 150);

            // Draw the lines
            let dst = new cv.Mat.zeros(edges.rows, edges.cols, cv.CV_8UC3);
            for (let i = 0; i < lines.rows; ++i) {
                let rho = lines.data32F[i*2];
                let theta = lines.data32F[i*2 + 1];
                let a = Math.cos(theta);
                let b = Math.sin(theta);
                let x0 = a*rho;
                let y0 = b*rho;
                let pt1 = {x: Math.round(x0 + 1000*(-b)), y: Math.round(y0 + 1000*(a))};
                let pt2 = {x: Math.round(x0 - 1000*(-b)), y: Math.round(y0 - 1000*(a))};
                cv.line(dst, pt1, pt2, [0, 0, 255, 255], 3, cv.LINE_AA, 0);
            }

            // Show the output image
            cv.imshow('canvasOutput', dst);

            // Free memory
            src_gray.delete(); edges.delete(); lines.delete(); dst.delete();
        }

        // Function to handle file selection
        function onFileSelected(event) {
            let file = event.target.files[0];
            let reader = new FileReader();
            reader.onload = function(event) {
                let img = new Image();
                img.onload = function() {
                    // Create a canvas to draw the image
                    let canvasInput = document.getElementById('canvasInput');
                    canvasInput.width = img.width;
                    canvasInput.height = img.height;
                    let ctx = canvasInput.getContext('2d');
                    ctx.drawImage(img, 0, 0, img.width, img.height);

                    // Load the image from canvas
                    let src = cv.imread(canvasInput);

                    // Perform Hough Transform for lines
                    performHoughTransform(src);

                    // Free memory
                    src.delete();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>
